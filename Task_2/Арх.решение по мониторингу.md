## Архитектурное решение по мониторингу

### 1. Мотивация
    Напишите здесь, почему в систему нужно добавить мониторинг и что это даст компании.
Мониторинг позволит:
- подтвердить гипотезы происхождения существующих продуктовых и технических проблем;
- определить порядок мероприятий для требуемых изменения архитектуры, например, масштабирования, разделения сервисов
- улучшить observability в целом, например:
    - быстрей выявлять проблемы и повысить надежность системы;
    - повышать удовлетворенность пользователей;

### 2. Выбор подхода к мониторингу
    Выберите, какой подход к мониторингу вы будете использовать: RED, USE или «Четыре золотых сигнала». 
    Для разных частей системы можно использовать разные подходы

| **Компонент**                                       | **Метод мониторинга** | *Обоснование*                                                                                                                                                                                                                |
|:----------------------------------------------------|:----------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 3d files storage                                    | 4GS                   | 4GS позволит оценить состояние внешнего S3 хранилища                                                                                                                                                                         |
| MES API, SHOP_API, CRM_API - уровень инфраструктуры | USE                   | USE позволит понять использование системных ресурсов                                                                                                                                                                         |
| MES API, SHOP_API, CRM_API - уровень продукта       | 4GS                   | 4GS позволит оценить состояние API сервисов, в том числе с помощью продуктовых метрик                                                                                                                                        |
| Messages queue                                      | USE + RED             | USE неплохо подходит для мониторинга использования ресурсов брокера (CPU, memory, размера очереди и т.п.), а RED - лучше подойдет для оценки оценки потоков записи и чтения в топики, а также возникающих продуктовых ошибок |
| MES DB, SHOP DB                                     | USE + 4GS частично    | USE позволяет контролировать нагрузку на ресурсы БД (connections, IO, CPU и т.п.), 4GS позволит лучше оценить параметры входящих к БД запросов                                                                               |


### 3. Метрики
    Опишите, какие метрики и в каких частях системы вы будете отслеживать. Перед вами список метрик. Выберите метрики, которые вы считаете нужным отслеживать. Для выбранных метрик напишите:
    - Зачем нужна эта метрика.
    - Нужны ли ярлыки для этой метрики. Если ярлыки нужны, опишите, какие именно вы планируете добавить.
    Вы можете не ограничивать себя только этим списком. Если вы видите, что стоит добавить какие-то ещё метрики, — добавьте и их тоже.

| **Компонент**                                       | **Метрики и теги**                                                                                                                                                                          | **Теги**                                           | **Обоснование**                                                                                                     |
|:----------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------|
| 3d files storage                                    |                                                                                                                                                                                             |                                                    |                                                                                                                     |
|                                                     | - 4GS Latency:<br/>p95/99_get_file_latency, p95/99_put_file_latency_%                                                                                                                       | host, geo                                          | Медленная загрузка файлов - сетевые задержки, увеличение других задержек - сможем спланировать масштабирование сети |
|                                                     | - 4GS Traffic:<br/>rps_queries;                                                                                                                                                             | endpoint, http_method, client_id                   | Сможем монять, нужно ли кэширование                                                                                 |
|                                                     | - 4GS Traffic:<br/>kb_transferred_api                                                                                                                                                       | endpoint, http_method, way=int/out, client_id      | Сможем спланировать масштабирование сети                                                                            |
|                                                     | - 4GS Errors:<br/>number_of_requests                                                                                                                                                        | endpoint, http_method, status_code, client_id      | Проценты 2хх, 4хх, 5хх и т.п. запросов к S3 позволят определить сбои с внешним провайдером                          |
|                                                     | - 4GS Saturation<br/>cpu_usage_%, memory_utilisation_%, disk_usage_%, network_usage_%                                                                                                       | host, geo                                          | Состояние ресурсов для оценки необходимости масшабирования                                                          |
| MES API, SHOP_API, CRM_API - уровень инфраструктуры |                                                                                                                                                                                             |                                                         |                                                                                                                                                             |
|                                                     | - USE Utilisation:<br/>cpu_usage_%, memory_utilisation_%, network_usage_%;                                                                                                                  | host, geo                                               | Состояние ресурсов для оценки необходимости масшабирования                                                                                                  |
|                                                     | - USE Saturation:<br/>cpu_throttled_time, memory_swap_usage;                                                                                                                                | host, geo                                               | Сигнализация о наличии явных проблем                                                                                                                        |
|                                                     | - USE Errors:<br/>oom_kills, restarts;                                                                                                                                                      
| MES API, SHOP_API, CRM_API - уровень продукта       |                                                                                                                                                                                             |                                                         |                                                                                                                                                             |
|                                                     | - 4GS Latency:<br/>p95/p99_latency_shop_api, p95/p99_latency_mes_api, p95/p99_latency_crm_api                                                                                               | endpoint, http_method, status_code, client_id, order_id | Сможем точнее определить деградацию различных API и реагировать, чтобы избежать финансовых и прочих потерь                                                  |
|                                                     | - 4GS Latency:<br/>order_with_production_latency, order_without_production_latency                                                                                                          | order_id, product_id, client_id                         | Продуктовые метрика времени выполнения заказов (с производством и готовых)                                                                                  |
|                                                     | - 4GS Traffic:<br/>shop_order_created, shop_file_uploaded, mes_file_uploaded, crm_order_confirmed, mes_price_calculated, mes_production_started, mes_production_finished, mes_order_shipped | order_id, product_id, client_id                         | Продуктовые метрики ключевых вызовов, которые позволяют оценить аномалии в бизнесс-процессах                                                                |
|                                                     | - 4GS Traffic:<br/>rps_shop_api, rps_mes_api, rps_crm_api                                                                                                                                   | endpoint, http_method, client_id, order_id              | Наблюдение за пиками нагрузки (в течение суток, недели, акций) позволит планировать масштабирование                                                         |
|                                                     | - 4GS Traffic:<br/>kb_transferred_shop_api, kb_transferred_mes_api, kb_transferred_crm_api                                                                                                  | endpoint, http_method, way=int/out, client_id, order_id | Отслеживание размеров данных для анализа роста, аномалий                                                                                                    |
|                                                     | - 4GS Errors:<br/>number_of_requests_shop_api, number_of_requests_mes_api, number_of_requests_crm_api                                                                                       | endpoint, http_method, status_code, client_id, order_id | Проценты 2хх, 5хх и т.п. запросов к API-бэкендам позволят определить ошибки в данных/обработке данных на ранних этапах                                      |
|                                                     | - 4GS Saturation<br/>http_pool_saturation, thread_pool_saturation                                                                                                                           | pool=thread/http/db, max_pool_size                      | Переполнение пулов, таймауты в потоках -> увеличение latency -> тюнинг пулов и потоков                                                                      |
| Messages Queue                                      |                                                                                                                                                                                             |                                                         |                                                                                                                                                             |
|                                                     | - USE Utilisation:<br/>cpu_usage_%, memory_utilisation_%;                                                                                                                                   | host, geo                                               | Состояние ресурсов для оценки необходимости масшабирования                                                                                                  |
|                                                     | - USE Saturation:<br/>cpu_throttled_time, memory_swap_usage, queue_messages_size, dead_letter_queue_messages_size, consumer_lag_s;                                                          | host, topic, consumer                                   | Сигнализация о наличии проблем с разбором сообщений                                                                                                         |
|                                                     | - USE Errors:<br/>broker_restarts_rate, replication_errors_rate;                                                                                                                            | host, reason                                            | Стабильность кластера messages queue                                                                                                                        |
|                                                     | - RED Rate:<br/>messages_in, messages_out                                                                                                                                                   | topic, producer, consumer                               | Сможем оценить изменения в потоках данных консьюмеров и продьюсеров                                                                                         |
|                                                     | - RED Errors:<br/>messages_rejected_with_code, messages_rejected_with_rate                                                                                                                  | topic, producer,consumer, business_reason               | Продуктовая метрика потерянных сообщений с причинами                                                                                                        |
|                                                     | - RED Duration:<br/>end‑to‑end processing latency (publish→ack)                                                                                                                             | topic, consumer                                         | Задержка обработки сообщений                                                                                                                                |
| MES DB, SHOP DB                                     |                                                                                                                                                                                             |                                                         |                                                                                                                                                             |
|                                                     | - USE Utilisation:<br/>cpu_usage_%, memory_utilisation_%, disk_usage_%, network_usage_%                                                                                                     | host                                                    | Состояние ресурсов для оценки необходимости масшабирования                                                                                                  |
|                                                     | - USE Saturation:<br/> network_io, wait_connections_%, max_connections, replications_lag_s;                                                                                                 | host, role=primary/replika                              | Состояние подключений и репликации - про доступность и актуальность данных                                                                                  |
|                                                     | - USE Errors:<br/> failed_query_with_code, failed_queries_rate;                                                                                                                             | user, error_level, error_code                           | Падения запросов из-за багов вызывающих сервисов, например синтаксис SQL, или других причин - ретраи, ошибки для пользователей, например, зависания заказов |
|                                                     | - 4GS Latency:<br/>p95_query_latency, p99_query_latency, longest_query_time_ms                                                                                                              | db_name, table, query_type=UPDATE,SELECT,INSERT,DELETE  | Медленные запросы - тормоза, например, в MES                                                                                                                |
|                                                     | - 4GS Traffic:<br/>queries_per_second, wal_size                                                                                                                                             | db_name                                                 | Мониторинг внешней нагрузки на базу                                                                                                                         |
|                                                     | - 4GS Errors:<br/>deadlocks_rate, conflict/lock_wait_time                                                                                                                                   | db_name, table, query_type=UPDATE,SELECT,INSERT,DELETE  | Конкурентные операции влияют на консистентность и актуальность данных, а также косвенно на повышенную нагрузку вызывающих сервисов (например, ретраи)       |

### 4. План действий по внедрению метрик
    Напишите высокоуровнево, какие задачи вы видите для реализации. 
    Это будет драфт технического задания. Например, «Создать инстанс time-series базы с использованием такой-то технологии».

1. Развертывание Clickhouse в качестве долговременного хранилища метрик в двух окружениях (testing и prod).
   - HA кластер с 2 инстансами + 3 узла ClickHouseKeeper в двух окружениях;
2. Развертывание кластера Prometheus (включая AlertsManager) для сбора метрик в двух окружениях - testing и prod.
   - по 2 инстанса в двух окружениях (testing и prod);
   - внутреннее хранилище TSDB на 30d;
   - настройка remote_write в долговременное хранилище ClickHouse;
3. Заведение 2 инстансов Grafana для обоих двух окружениях (testing и prod)
   - c подключением 4 хранилищ: prom_test, prom_prod, clickhouse_test и clickhouse_prod.
4. Подключение и настройка сбора метрик:
   - micrometer для spring boot API бэкендов;
   - exporter для rabbitMq;
   - postgres_exporter для БД;
   - сбор метрик с контейнеров;
5. Настройка новых дашбордов с метриками в Grafana.
6. Настройка алертов в AlertsManager с настройкой уведомлений, а также интеграция Grafana с AlertsManager для отображения алертов на дашбордах.

### 5. Алертинг и автодействия на примере некоторых метрик
    Выберите показатели насыщенности — определите, что является пороговым значением насыщенности и почему нужно использовать именно такие показатели. 
    Опишите, что должно происходить в системе в случае, если эти параметры будут превышены. 
    Например, нужно завести тикет, добавить инстансов, написать письмо в саппорт, добавить автоматическую «звонилку» и так далее

| **Метрика**                                                          | **Порог насыщенности**                                      | **Объяснение**                                                                     | **Действия**                                                                        |
|:---------------------------------------------------------------------|:------------------------------------------------------------|:-----------------------------------------------------------------------------------|:------------------------------------------------------------------------------------|
| USE saturation: cpu_throttled_time<br/>4GS saturation: cpu_time_%    | - 5% от wall-clock time за 5 мин<br/>- 90% в течение ≥5 мин | Хотим зафиксировать стабильные перегрузки, а не кратковременные (секунды) всплески | Алерт (MEDIUM) -> Попытка автодобавления инстансов -> Тикет дежурному               |
| USE saturation: queue_messages_size, dead_letter_queue_messages_size | 2×RPS потребления за предыдущие 5 мин                       | Хотим увидеть начальный момент необычного (не регулярного) роста очереди           | Алерт (HIGH) -> Автоскейлинг консьюмеров -> Звонок дежурному -> Тикет для дежурного |
| USE saturation: wait_connections_%                                   | 80% max_connections                                         | Хотим увидеть проблему раньше, чем соединения закончатся и начнется деградация     | Алерт (HIGH) -> Звонок дежурному -> Тикет на поиск решения проблемы                 |
